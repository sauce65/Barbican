# Barbican Security Module: Vulnerability Scanning
#
# NIST 800-53 Controls:
# - RA-5: Vulnerability Monitoring and Scanning
# - SI-2: Flaw Remediation
#
# Runs vulnix against the system closure on a schedule, generates JSON
# reports, and optionally alerts on critical CVEs via webhook.
{ config, lib, pkgs, ... }:

with lib;

let
  cfg = config.barbican.vulnScanning;

  # Profile-dependent defaults
  profileSchedule = {
    development = "monthly";
    low         = "monthly";
    moderate    = "weekly";
    high        = "daily";
  };

  profileAlertOnCritical = {
    development = false;
    low         = false;
    moderate    = true;
    high        = true;
  };

  effectiveSchedule = if cfg.schedule != null then cfg.schedule
    else profileSchedule.${cfg.profile};

  timerCalendar = {
    daily   = "*-*-* 03:00";
    weekly  = "Sun 03:00";
    monthly = "*-*-01 03:00";
  }.${effectiveSchedule} or cfg.scanTime;

  scanScript = pkgs.writeShellScript "barbican-vuln-scan" ''
    set -euo pipefail

    REPORT_DIR="${cfg.reportDir}"
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    REPORT_FILE="$REPORT_DIR/vuln-report_$TIMESTAMP.json"

    mkdir -p "$REPORT_DIR"

    echo "=== Barbican Vulnerability Scan ==="
    echo "Time: $(date -Iseconds)"
    echo "Profile: ${cfg.profile}"

    ${optionalString cfg.enableNixAudit ''
      # Run vulnix against the current system closure
      echo "Scanning system closure for known CVEs..."
      ${pkgs.vulnix}/bin/vulnix --system \
        --json > "$REPORT_FILE" 2>/dev/null || true

      if [ -f "$REPORT_FILE" ] && [ -s "$REPORT_FILE" ]; then
        # Count vulnerabilities
        TOTAL=$(${pkgs.jq}/bin/jq 'length' "$REPORT_FILE" 2>/dev/null || echo "0")
        echo "Found $TOTAL packages with known vulnerabilities"

        ${optionalString cfg.alertOnCritical ''
          # Check for critical/high severity CVEs
          CRITICAL=$(${pkgs.jq}/bin/jq '[.[] | select(.cvssv3_basescore != null and .cvssv3_basescore >= 9.0)] | length' "$REPORT_FILE" 2>/dev/null || echo "0")

          if [ "$CRITICAL" -gt 0 ]; then
            echo "ALERT: $CRITICAL critical vulnerabilities found!"

            ${optionalString (cfg.alertWebhookUrl != null) ''
              # Send alert via webhook
              ALERT_PAYLOAD=$(${pkgs.jq}/bin/jq -n \
                --arg host "$(hostname)" \
                --arg count "$CRITICAL" \
                --arg total "$TOTAL" \
                --arg time "$(date -Iseconds)" \
                '{
                  text: "Vulnerability Alert: \($count) critical CVEs on \($host) (\($total) total affected packages)",
                  host: $host,
                  critical_count: ($count | tonumber),
                  total_affected: ($total | tonumber),
                  timestamp: $time
                }')
              ${pkgs.curl}/bin/curl -sf -X POST \
                -H "Content-Type: application/json" \
                -d "$ALERT_PAYLOAD" \
                "${cfg.alertWebhookUrl}" || echo "WARNING: Failed to send alert webhook"
            ''}
          fi
        ''}
      else
        echo "No vulnerabilities found or scan produced no output"
        echo "[]" > "$REPORT_FILE"
      fi
    ''}

    # Cleanup old reports
    find "$REPORT_DIR" -name "vuln-report_*.json" -mtime +90 -delete 2>/dev/null || true

    chmod 600 "$REPORT_FILE"
    echo "Report saved: $REPORT_FILE"
    echo "=== Scan Complete ==="
  '';

in {
  options.barbican.vulnScanning = {
    enable = mkEnableOption "Vulnerability scanning (RA-5, SI-2)";

    schedule = mkOption {
      type = types.nullOr (types.enum [ "daily" "weekly" "monthly" ]);
      default = null;
      description = "Scan schedule. Defaults based on profile if not set.";
    };

    scanTime = mkOption {
      type = types.str;
      default = "Sun 03:00";
      description = "Systemd calendar time for scans (used when schedule maps to this)";
    };

    reportDir = mkOption {
      type = types.path;
      default = "/var/lib/barbican/vuln-reports";
      description = "Directory for vulnerability scan reports";
    };

    enableNixAudit = mkOption {
      type = types.bool;
      default = true;
      description = "Run vulnix against system Nix closure";
    };

    alertOnCritical = mkOption {
      type = types.bool;
      default = profileAlertOnCritical.${cfg.profile};
      defaultText = literalExpression "depends on profile";
      description = "Alert when critical (CVSS >= 9.0) vulnerabilities are found";
    };

    alertWebhookUrl = mkOption {
      type = types.nullOr types.str;
      default = null;
      description = "Webhook URL for critical vulnerability alerts";
    };

    profile = mkOption {
      type = types.enum [ "development" "low" "moderate" "high" ];
      default = "moderate";
      description = "Security profile controlling scan frequency and alerting";
    };
  };

  config = mkIf cfg.enable {
    # Scan service (oneshot)
    systemd.services.barbican-vuln-scan = {
      description = "Barbican Vulnerability Scan (RA-5)";

      serviceConfig = {
        Type = "oneshot";
        ExecStart = "${scanScript}";
      };

      path = [ pkgs.coreutils pkgs.findutils ];
    };

    # Scan timer
    systemd.timers.barbican-vuln-scan = {
      description = "Barbican Vulnerability Scan Timer";
      wantedBy = [ "timers.target" ];

      timerConfig = {
        OnCalendar = timerCalendar;
        Persistent = true;
        RandomizedDelaySec = "15m";
      };
    };

    # Ensure report directory exists
    systemd.tmpfiles.rules = [
      "d ${cfg.reportDir} 0700 root root -"
    ];
  };
}
